# 复杂变更本地处理指南

## 概述

当 MR 的代码变更过于复杂，仅通过 diff 无法充分理解时，需要将变更应用到本地工程，结合完整的代码上下文进行深度 review。

## 何时需要本地处理

### 判断标准

建议在以下情况使用本地处理流程：

1. **规模指标**
   - 变更超过 500 行
   - 涉及超过 10 个文件
   - 多个模块同时变更

2. **复杂度指标**
   - 包含重大的重构
   - 涉及架构层面的改动
   - 跨多个服务或组件的变更
   - 复杂的逻辑变更或算法修改

3. **依赖关系**
   - 需要理解多个文件之间的关系
   - 需要运行测试验证
   - 需要静态分析工具支持

## 本地处理流程

### 步骤 1: 准备工作

1. **确认工作目录**
   - 确保当前在正确的代码仓库中
   - 确认分支状态（建议从干净的起点开始）
   - 备份当前状态（创建临时分支或 stash）

2. **获取 Diff**
   ```bash
   # 使用 MCP 工具下载 diff
   diff_file = mcp_tool.download_diff(mr_url, output_path)
   ```

### 步骤 2: 应用 Patch

1. **验证 Patch 格式**
   - 检查 diff 文件格式（unified diff, git diff 等）
   - 确认 patch 适用性

2. **应用 Patch**
   ```bash
   # 方法 1: 使用 git apply
   git apply < diff_file.patch

   # 方法 2: 使用 patch 命令
   patch -p1 < diff_file.patch

   # 方法 3: 使用 git am（如果是 git format-patch 生成的）
   git am < diff_file.patch
   ```

3. **处理冲突**
   - 如果有冲突，标记并手动解决
   - 记录冲突情况以供参考

4. **验证应用结果**
   ```bash
   # 查看变更状态
   git status
   git diff --stat

   # 查看具体变更
   git diff
   ```

### 步骤 3: 本地分析

1. **代码静态分析**
   - 运行 linter
   - 运行类型检查（如适用）
   - 使用其他静态分析工具

2. **运行测试**
   ```bash
   # 运行单元测试
   npm test  # 或 pytest, mvn test 等

   # 运行集成测试（如果可用）
   ```

3. **手动验证**
   - 阅读相关代码文件
   - 理解变更的上下文
   - 检查变更的影响范围

### 步骤 4: 深度 Review

结合本地完整代码库进行审查：

1. **架构层面**
   - 评估对整体架构的影响
   - 检查是否符合设计原则
   - 识别潜在的架构风险

2. **依赖关系**
   - 分析新增的依赖
   - 检查对现有依赖的影响
   - 评估循环依赖风险

3. **性能影响**
   - 识别潜在的性能问题
   - 评估资源使用变化
   - 检查是否有性能优化的机会

4. **安全性**
   - 检查是否引入安全漏洞
   - 验证权限和认证处理
   - 评估数据安全性

### 步骤 5: 清理和恢复

完成 review 后，清理本地变更：

```bash
# 查看变更
git status

# 恢复到原始状态（方法 1: reset）
git reset --hard HEAD

# 恢复到原始状态（方法 2: checkout）
git checkout .

# 如果创建了临时分支，切换回原分支并删除临时分支
git checkout main
git branch -D temp-review-branch
```

## 最佳实践

1. **始终备份** - 在应用 patch 前确保当前工作已保存
2. **隔离环境** - 使用临时分支或工作目录
3. **验证结果** - 确保 patch 正确应用后再进行 review
4. **及时清理** - Review 完成后立即清理，避免影响后续工作
5. **记录问题** - 如果 patch 无法应用或有问题，记录并报告

## 故障排除

### Patch 应用失败

**问题**: patch 无法应用，出现冲突

**解决方案**:
1. 检查 diff 格式是否正确
2. 确认目标分支与 patch 的基准一致
3. 尝试使用不同的应用方法（git apply vs patch）
4. 手动解决冲突

### 测试失败

**问题**: 应用 patch 后测试失败

**解决方案**:
1. 确认测试环境配置正确
2. 检查是否有遗漏的文件或配置
3. 分析失败原因，在 review 中注明
4. 如果是测试本身的问题，建议修复测试

### 无法理解变更

**问题**: 即使有了完整代码，仍无法理解变更意图

**解决方案**:
1. 在 review 意见中明确说明不清楚的部分
2. 建议提交者补充文档或注释
3. 请求提交者提供额外的上下文说明

## 工具集成

未来可以考虑自动化部分流程：

- 自动下载和应用 patch 的脚本
- 自动运行测试套件
- 自动生成 review 报告模板
- 与 CI/CD 系统集成
